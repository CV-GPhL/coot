<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="lhasa.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  </head>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
    var Module = {
      onRuntimeInitialized: function() {
        // console.log('lerp result: ' + Module.lerp(1, 2, 0.5));
        console.log('Module is here.');
        lh = new Module.LhasaCanvas();

        const elem = document.getElementById("editor_canvas_container");
        elem.addEventListener("mousemove", (event) => {
          // console.log('Mousemove');
          lh.on_hover(event.clientX, event.clientY, event.altKey);
        });
        elem.addEventListener("mousedown", (event) => {
          if(event.button == 0) {
            //console.log('lclick');
            lh.on_left_click(event.clientX, event.clientY, event.altKey, event.ctrlKey, event.shiftKey);
          } else if(event.button == 2) {
            //console.log('rclick');
            lh.on_right_click(event.clientX, event.clientY, event.altKey, event.ctrlKey, event.shiftKey);
          }
        });
        elem.addEventListener("mouseup", (event) => {
          if(event.button == 0) {
            //console.log('lreleased');
            lh.on_left_click_released(event.clientX, event.clientY, event.altKey, event.ctrlKey, event.shiftKey);
          } else if(event.button == 2) {
            //console.log('rreleased');
            lh.on_right_click_released(event.clientX, event.clientY, event.altKey, event.ctrlKey, event.shiftKey);
          }
        });
        const on_render = function() {
          console.log("on_render() called.");
          const ren = new Module.LhasaRenderer("dummy");
          lh.render(ren);
          const commands = ren.get_commands();
          const svg = d3.create("svg")
            .attr("id", "lhasa_drawing")
            .attr("width", lh.measure(Module.LhasaMeasurementDirection.HORIZONTAL).requested_size)
            .attr("height", lh.measure(Module.LhasaMeasurementDirection.VERTICAL).requested_size);
          for(var i = 0; i < commands.size(); i++) {
            const command = commands.get(i);
            // console.log('line arc path: ' + command.is_line() + ' ' + command.is_arc() + ' ' + command.is_path());
            if(command.is_line()) {
              const line = command.as_line();
              // console.log(line);
              svg.append("line")
                .attr("x1", line.start.x)
                .attr("y1", line.start.y)
                .attr("x2", line.end.x)
                .attr("y2", line.end.y)
                .attr("stroke", 'rgba(' + line.style.r * 255 + ','+ line.style.g * 255 + ',' + line.style.b * 255 + ',' + line.style.a + ')')
                .attr("stroke-width", line.style.line_width);

            }
          }
          commands.delete();
          ren.delete();

          const elem = document.getElementById("editor_canvas_container");
          while (elem.firstChild) {
            elem.removeChild(elem.lastChild);
          }
          elem.append(svg.node());
        };
        // For now, "queue_redraw" will just render immediately
        lh.connect("queue_redraw", on_render);
        const on_status_updated = function (status_text) {
          // For now
          console.log("Status: " + status_text);
          const elem = document.getElementById("status_display");
          while (elem.firstChild) {
            elem.removeChild(elem.lastChild);
          }
          elem.textContent = status_text;
        };
        lh.connect("status_updated", on_status_updated);
        lh.connect("smiles_changed", function () {
          const elem = document.getElementById("smiles_display");
          while (elem.firstChild) {
            elem.removeChild(elem.lastChild);
          }
          const smiles_raw = lh.get_smiles();
          elem.textContent = smiles_raw;

          // This is broken. TODO: FIX

          // const smiles_array = smiles_raw.split("\n");
          // //console.log("array: ", smiles_array);
          // //const smiles_array = smiles_raw.split("/\r?\n/");
          // for(const smiles_string in smiles_array) {
          //   const m_div = document.createElement("div");
          //   m_div.innerHTML = smiles_string;
          //   //m_div.textContent = smiles_string;
          //   elem.append(m_div);
          // }
        });
        console.log('Adding demo molecule.');
        Module.append_from_smiles(lh, "O=C(C)Oc1ccccc1C(=O)O");
      }
    };
  </script>
  <script src="lhasa.js"></script>

  <body>
    <div id="molecule_tools_toolbar" class="horizontal_toolbar toolbar horizontal_container">
      <div class="button">Move</div>
      <div class="button">Rotate</div>
      <div class="button">Flip around X</div>
      <div class="button">Flip around Y</div>
      <div class="button">Delete hydrogens</div>
      <div class="button">Format</div>
    </div>
    <div id="main_tools_toolbar" class="horizontal_toolbar toolbar horizontal_container">
      <div class="button">Single Bond</div>
      <div class="button">Double Bond</div>
      <div class="button">Triple Bond</div>
      <div class="button">Geometry</div>
      <div class="button">Charge</div>
      <div class="button">Delete</div>
    </div>
    <div id="structure_toolbar" class="horizontal_toolbar toolbar horizontal_container">
      <div class="button">3-C</div>
      <div class="button">4-C</div>
      <div class="button">5-C</div>
      <div class="button">6-C</div>
      <div class="button">6-Arom</div>
      <div class="button">7-C</div>
      <div class="button">8-C</div>
    </div>
    <div id="main_horizontal_container" class="horizontal_container">
      <div id="element_toolbar" class="vertical_toolbar toolbar vertical_container">
        <div class="button">C</div>
        <div class="button">N</div>
        <div class="button">O</div>
        <div class="button">S</div>
        <div class="button">P</div>
        <div class="button">H</div>
        <div class="button">F</div>
        <div class="button">Cl</div>
        <div class="button">Br</div>
        <div class="button">I</div>
        <div class="button">X</div>
      </div>
      <div id="editor_canvas_container">
      </div>
    </div>
    <div id="status_display">

    </div>
    <div id="smiles_display_outer">
      SMILES:
      <div id="smiles_display">
        <!-- Smiles goes here -->
      </div>
    </div>
    <div id="bottom_toolbar" class="horizontal_toolbar toolbar horizontal_container">
      <!-- edit undo, display mode, smiles imports, etc. -->
      <div class="button"></div>
    </div>
  </body>
</html>
