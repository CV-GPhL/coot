<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  </head>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
    var Module = {
      onRuntimeInitialized: function() {
        // console.log('lerp result: ' + Module.lerp(1, 2, 0.5));
        console.log('Module is here.');
        lh = new Module.LhasaCanvas();
        console.log('Adding demo molecule.');
        Module.append_from_smiles(lh, "O=C(C)Oc1ccccc1C(=O)O");

        const elem = document.getElementById("editor_canvas");
        elem.addEventListener("mousemove", (event) => {
          // console.log('Mousemove');
          lh.on_hover(event.clientX, event.clientY, event.altKey);
        });
        elem.addEventListener("mousedown", (event) => {
          if(event.button == 0) {
            lh.on_left_click(event.clientX, event.clientY, event.altKey, event.ctrlKey, event.shiftKey);
          } else if(event.button == 2) {
            lh.on_right_click(event.clientX, event.clientY, event.altKey, event.ctrlKey, event.shiftKey);
          }
        });
        elem.addEventListener("mouseup", (event) => {
          if(event.button == 0) {
            lh.on_left_click_released(event.clientX, event.clientY, event.altKey, event.ctrlKey, event.shiftKey);
          } else if(event.button == 2) {
            lh.on_right_click_released(event.clientX, event.clientY, event.altKey, event.ctrlKey, event.shiftKey);
          }
        });
        const on_render = function() {
          console.log("on_render() called.");
          const ren = new Module.LhasaRenderer("dummy");
          lh.render(ren);
          const commands = ren.get_commands();
          const svg = d3.create("svg")
            .attr("id", "editor_canvas");
          for(var i = 0; i < commands.size(); i++) {
            const command = commands.get(i);
            // console.log('line arc path: ' + command.is_line() + ' ' + command.is_arc() + ' ' + command.is_path());
            if(command.is_line()) {
              const line = command.as_line();
              // console.log(line);
              svg.append("line")
                .attr("x1", line.start.x)
                .attr("y1", line.start.y)
                .attr("x2", line.end.x)
                .attr("y2", line.end.y)
                .attr("stroke", 'rgba(' + line.style.r + ','+ line.style.g + ',' + line.style.b + ',' + line.style.a + ')');

            }
          }
          commands.delete();
          ren.delete();

          const elem = document.getElementById("editor_canvas");
          while (elem.firstChild) {
            elem.removeChild(elem.lastChild);
          }
          elem.append(svg.node());
        };
        on_render();
      }
    };
  </script>
  <script src="lhasa.js"></script>

  <body>
    <div id="editor_canvas">
    </div>
  </body>
</html>
