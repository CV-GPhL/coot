<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="lhasa.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  </head>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
    var Module = {
      onRuntimeInitialized: function() {
        // console.log('lerp result: ' + Module.lerp(1, 2, 0.5));
        console.log('Module is here.');

        lh = new Module.LhasaCanvas();

        switch_tool = function (element, tool) {
          let buttons = document.querySelectorAll('.tool_button');
          for(let i = 0; i < buttons.length; i++) {
            const button = buttons[i];
            const class_list = button.classList;
            //console.log(class_list);
            class_list.remove('active_tool');
          }
          element.classList.add('active_tool');
          lh.set_active_tool(Module.make_active_tool(tool));
        };
        const elem = document.getElementById("editor_canvas_container");
        // Disables right-click menu
        elem.oncontextmenu =new Function("return false;");
        elem.addEventListener("mousemove", (event) => {
          // console.log('Mousemove');
          lh.on_hover(event.offsetX, event.offsetY, event.altKey);
        });
        elem.addEventListener("mousedown", (event) => {
          if(event.button == 0) {
            //console.log('lclick');
            lh.on_left_click(event.offsetX, event.offsetY, event.altKey, event.ctrlKey, event.shiftKey);
          } else if(event.button == 2) {
            //console.log('rclick');
            lh.on_right_click(event.offsetX, event.offsetY, event.altKey, event.ctrlKey, event.shiftKey);
          }
        });
        elem.addEventListener("mouseup", (event) => {
          if(event.button == 0) {
            //console.log('lreleased');
            lh.on_left_click_released(event.offsetX, event.offsetY, event.altKey, event.ctrlKey, event.shiftKey);
          } else if(event.button == 2) {
            //console.log('rreleased');
            lh.on_right_click_released(event.offsetX, event.offsetY, event.altKey, event.ctrlKey, event.shiftKey);
          }
        });
        elem.addEventListener("wheel", (event) => {
          lh.on_scroll(event.deltaX, event.deltaY, event.ctrlKey);
        });
        const on_render = function() {
          console.debug("on_render() called.");
          const css_color_from_lhasa_color = (lhasa_color) => {
            return 'rgba(' + lhasa_color.r * 255 + ','+ lhasa_color.g * 255 + ',' + lhasa_color.b * 255 + ',' + lhasa_color.a + ')';
          }
          const lhasa_text_to_d3js = (msvg, text) => {
            const style_to_attrstring = (style) => {
              let style_string = "";
              if(style.specifies_color) {
                style_string += "fill:";
                style_string += css_color_from_lhasa_color(style.color);
                style_string += ";";
              }
              // font-size:65%;baseline-shift:sub / super
              switch(style.positioning) {
                case Module.LhasaTextPositioning.Normal:
                  // nothing to do
                  break;
                case Module.LhasaTextPositioning.Sub:
                  style_string += "font-size:65%;baseline-shift:sub;";
                  break;
                case Module.LhasaTextPositioning.Super:
                  style_string += "font-size:65%;baseline-shift:super;";
                  break;
              }
              if(style.weight != "") {
                style_string += "font-weight:";
                style_string += style.weight;
                style_string += ";";
              }
              if(style.size != "") {
                style_string += "font-size:";
                style_string += style.size;
                style_string += ";";
              }
              return style_string;
            };
            const append_spans_to_node = (spans, text_node) => {
              for(let i = 0; i < spans.size(); i++) {
                const span = spans.get(i);
                let child = text_node
                  // .enter()
                  .append("tspan");
                if(span.specifies_style) {
                  child.attr("style", style_to_attrstring(span.style));
                }
                if(span.has_subspans()) {
                  append_spans_to_node(span.as_subspans(), child);
                } else {
                  const caption = span.as_caption();
                  child.text(caption);
                }
              }
              // return ret;
            }
            const ret = msvg.append("text")
              .attr("x", text.origin.x)
              .attr("y", text.origin.y);
            
            const style_string = style_to_attrstring(text.style);
            if(style_string != "") {
              ret.attr("style", style_string);
            } else {
              // console.warn("Empty style string!");
            }
            if(text.spans.size() == 0) {
              console.warn("Text contains no spans!");
            }
            append_spans_to_node(text.spans, ret);
            return ret;
          };
          const text_measure_function = (text) => {
            // let size_info = new Module.LhasaTextSize;
            let size_info = {
              'width': 0,
              'height': 0
            };
            try{
              const parent = document.getElementById("editor_canvas_container");
              const msvg = d3.create("svg")
                .attr("width", 100)
                .attr("height", 100)
                .attr("id", "measurement_temporary");
              const text_elem = lhasa_text_to_d3js(msvg, text);
              parent.append(msvg.node());
              const node = text_elem.node();
              const bbox = node.getBBox();
              size_info.width = Math.ceil(bbox.width);
              size_info.height = Math.ceil(bbox.height);
              msvg.remove();
            } catch(err) {
              console.error('Error occured in text measurement: ', err);
            } finally {
              return size_info;
            }
            
          };
          const ren = new Module.LhasaRenderer(text_measure_function);
          lh.render(ren);
          const commands = ren.get_commands();
          const svg = d3.create("svg")
            .attr("id", "lhasa_drawing")
            .attr("width", lh.measure(Module.LhasaMeasurementDirection.HORIZONTAL).requested_size)
            .attr("height", lh.measure(Module.LhasaMeasurementDirection.VERTICAL).requested_size);

          const render_commands = (cmds) => {
            for(var i = 0; i < cmds.size(); i++) {
              const command = cmds.get(i);
              if(command.is_line()) {
                const line = command.as_line();
                const color = line.style.color;
                svg.append("line")
                  .attr("x1", line.start.x)
                  .attr("y1", line.start.y)
                  .attr("x2", line.end.x)
                  .attr("y2", line.end.y)
                  .attr("stroke", css_color_from_lhasa_color(color))
                  .attr("stroke-width", line.style.line_width);

              } else if(command.is_arc()) {
                const arc = command.as_arc();
                console.log("todo: render arcs");

              } else if(command.is_path()) {
                const path = command.as_path();
                render_commands(path.commands);
                console.log("todo: implement fills for paths.");

              } else if(command.is_text()) {
                const text = command.as_text();
                lhasa_text_to_d3js(svg, text);
              }
            }
          };
          render_commands(commands);
          commands.delete();
          ren.delete();

          const elem = document.getElementById("editor_canvas_container");
          while (elem.firstChild) {
            elem.removeChild(elem.lastChild);
          }
          elem.append(svg.node());
        };
        // todo: decide what "queue_resize" should do.
        // For now, "queue_redraw" will just render immediately
        lh.connect("queue_redraw", on_render);
        const on_status_updated = function (status_text) {
          // For now
          console.log("Status: " + status_text);
          const elem = document.getElementById("status_display");
          while (elem.firstChild) {
            elem.removeChild(elem.lastChild);
          }
          elem.textContent = status_text;
        };
        lh.connect("status_updated", on_status_updated);
        lh.connect("smiles_changed", function () {
          const elem = document.getElementById("smiles_display");
          while (elem.firstChild) {
            elem.removeChild(elem.lastChild);
          }
          const smiles_raw = lh.get_smiles();

          const smiles_array = smiles_raw.split("\n");
          //console.log("array: ", smiles_array);
          //const smiles_array = smiles_raw.split("/\r?\n/");
          for(let i = 0; i < smiles_array.length; i++) {
            const m_div = document.createElement("div");
            m_div.innerHTML = smiles_array[i];
            //m_div.textContent = smiles_array[i];
            elem.append(m_div);
          }
        });
        lh.connect("molecule_deleted", function (mol_id) {
          console.log("Molecule with id " + mol_id + " has been deleted.");
        });
        lh.connect("scale_changed", function (new_scale) {
          const elem = document.getElementById("scale_display");
          while (elem.firstChild) {
            elem.removeChild(elem.lastChild);
          }
          elem.textContent = '' + new_scale;
        });
        const smiles_import_button = document.getElementById("smiles_import_button");
        smiles_import_button.addEventListener("click", function (el) {
          const smiles_input = document.getElementById("smiles_input");
          Module.append_from_smiles(lh, smiles_input.value);
        });
        // For now
        console.log('Adding demo molecule.');
        Module.append_from_smiles(lh, "O=C(C)Oc1ccccc1C(=O)O");
        lh.set_scale(1.0);

        on_x_element_button = (button) => {
          const panel = document.getElementById("x_element_panel");
          panel.style.display = 'flex';
        };

        on_x_element_submit_button = (button) => {
          const symbol_input = document.getElementById("x_element_symbol_input");
          const err_display = document.getElementById("error_display");
          try {
            const el_ins = Module.element_insertion_from_symbol(symbol_input.value);
            switch_tool(button, el_ins);
            const panel = document.getElementById("x_element_panel");
            panel.style.display = 'none';
            err_display.style.display = 'none';
          }catch(err) {
            console.warn("Could not set custom element: ", err);
            err_display.textContent = "Could not load ElementInsertion tool. Is your symbol valid?";
            err_display.style.display = 'flex';
          }
        };

        switch_display_mode = (value) => {
          switch(value) {
            default:
            case 'standard':
              lh.set_display_mode(Module.LhasaDisplayMode.Standard);
              break;
            case 'atom_indices':
              lh.set_display_mode(Module.LhasaDisplayMode.AtomIndices);
              break;
          }
        };
      }
    };
  </script>
  <script src="./lhasa.js" ></script>
  <body>
    <div id="lhasa_editor">
      <h3>Welcome to Lhasa!</h3>
      <p>
        Lhasa is a WebAssemby port of Layla - Coot's Ligand Editor.<br/>
        Lhasa is experimental software.
      </p>
      <div id="molecule_tools_toolbar" class="horizontal_toolbar toolbar horizontal_container">
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaTransformTool(Module.LhasaTransformMode.Translation))" >Move</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaTransformTool(Module.LhasaTransformMode.Rotation))" >Rotate</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaFlipTool(Module.LhasaFlipMode.Horizontal))" >Flip around X</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaFlipTool(Module.LhasaFlipMode.Vertical))" >Flip around Y</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaRemoveHydrogensTool())" >Delete hydrogens</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaFormatTool())" >Format</div>
      </div>
      <div id="main_tools_toolbar" class="horizontal_toolbar toolbar horizontal_container">
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaBondModifier(Module.LhasaBondModifierMode.Single))" >Single Bond</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaBondModifier(Module.LhasaBondModifierMode.Double))" >Double Bond</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaBondModifier(Module.LhasaBondModifierMode.Triple))" >Triple Bond</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaGeometryModifier())" >Geometry</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaChargeModifier())" ><!--img src="icons/layla_charge_tool.svg" width="24px" / ><br/-->Charge</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaDeleteTool())" >Delete</div>
      </div>
      <div id="structure_toolbar" class="horizontal_toolbar toolbar horizontal_container">
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaStructureInsertion(Module.LhasaStructure.CycloPropaneRing))" >3-C</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaStructureInsertion(Module.LhasaStructure.CycloButaneRing))" >4-C</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaStructureInsertion(Module.LhasaStructure.CycloPentaneRing))" >5-C</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaStructureInsertion(Module.LhasaStructure.CycloHexaneRing))" >6-C</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaStructureInsertion(Module.LhasaStructure.BenzeneRing))" >6-Arom</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaStructureInsertion(Module.LhasaStructure.CycloHeptaneRing))" >7-C</div>
        <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaStructureInsertion(Module.LhasaStructure.CycloOctaneRing))" >8-C</div>
      </div>
      <div id="x_element_panel" class="panel horizontal_container" >
        <span style="align-self: center;">Custom element symbol: </span>
        <input id="x_element_symbol_input"></input>
        <div class="button" id="x_element_submit_button" onclick="javascript:on_x_element_submit_button(this)">Submit</div>
      </div>
      <div id="error_display" class="vertical_container vertical_toolbar">

      </div>
      <div id="main_horizontal_container" class="horizontal_container">
        <div id="element_toolbar" class="vertical_toolbar toolbar vertical_container">
          <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaElementInsertion(Module.LhasaElement.C))" >C</div>
          <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaElementInsertion(Module.LhasaElement.N))" >N</div>
          <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaElementInsertion(Module.LhasaElement.O))" >O</div>
          <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaElementInsertion(Module.LhasaElement.S))" >S</div>
          <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaElementInsertion(Module.LhasaElement.P))" >P</div>
          <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaElementInsertion(Module.LhasaElement.H))" >H</div>
          <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaElementInsertion(Module.LhasaElement.F))" >F</div>
          <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaElementInsertion(Module.LhasaElement.Cl))" >Cl</div>
          <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaElementInsertion(Module.LhasaElement.Br))" >Br</div>
          <div class="button tool_button" onclick="javascript:switch_tool(this,new Module.LhasaElementInsertion(Module.LhasaElement.I))" >I</div>
          <div class="button tool_button" onclick="javascript:on_x_element_button(this)" >X</div>
        </div>
        <div id="editor_canvas_container">
          <div id="pre_render_message">Lhasa not loaded.</div>
        </div>
      </div>
      <div id="status_display_panel" class="panel">
        <span>▶</span>
        <span id="status_display"></span>
      </div>
      <div id="invalid_molecules_panel" class="panel">
        <input 
          type="checkbox" 
          id="allow_invalid_molecules_checkbox" 
          name="allow_invalid_molecules"
          onchange="javascript:lh.set_allow_invalid_molecules(this.checked);"
          >Allow invalid molecules</input>
      </div>
      <div id="info_block" class="horizontal_container">
        <div id="scale_panel" class="panel">
          <b>SCALE:</b>
          <div id="scale_display">
            <!-- scale info goes here -->
          </div>
          <div class="toolbar horizontal_toolbar horizontal_container">
            <div class="button" onclick="javascript:{const sc = lh.get_scale(); lh.set_scale(sc-0.05);}"><b>-</b></div>
            <div class="button" onclick="javascript:{const sc = lh.get_scale(); lh.set_scale(sc+0.05);}"><b>+</b></div>
          </div>
        </div>
        <div id="display_mode_panel" class="panel">
          <b>DISPLAY MODES</b>
          <br/><input type="radio" name="display_mode" checked value="standard" onchange="javascript:switch_display_mode(this.value);">Standard</input>
          <br/><input type="radio" name="display_mode" value="atom_indices" onchange="javascript:switch_display_mode(this.value);">Atom Indices</input>
          <!-- <input type="radio" name="display_mode" id="display_mode_atom_names">Atom Names</input> -->
        </div>
        <div id="smiles_display_outer" class="panel">
          <b>SMILES:</b>
          <div id="smiles_display">
            <!-- Smiles goes here -->
          </div>
        </div>
      </div>
      <div id="bottom_toolbar" class="horizontal_toolbar toolbar horizontal_container">
        <div class="button" onclick="javascript:lh.undo_edition()" >Undo</div>
        <div class="button" onclick="javascript:lh.redo_edition()" >Redo</div>
        <div class="horizontal_container toolbar">
          <input id="smiles_input"></input>
          <div class="button" id="smiles_import_button">Import SMILES</div>
        </div>
      </div>
      <div id="lhasa_footer">
        <i>Written by Jakub Smulski</i>
      </div>
    </div>
  </body>
</html>
